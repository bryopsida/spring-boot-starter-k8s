metadata:
  namespace: ${helm_namespace}
  labels:
    project: ${name}
    version: ${version}
spec:
  replicas: 1
  template:
    metadata:
      namespace: ${helm_namespace}
      labels:
        project: ${name}
        version: ${version}
    spec:
      imagePullSecrets:
        - name: ${pull_secret}
      volumes:
      - name: liquibase-changelog-volume
        configMap:
          name: liquibase-change-log-v1
      initContainers:
        - image: ${db_migration_job_image_repo}:${db_migration_job_image_tag}
          imagePullPolicy: ${image_pull_policy}
          name: db-migration
          resources:
            limits:
              memory: ${limits_memory}
            requests:
              memory: ${requests_memory}
          command: ["liquibase", "update", "--changeLogFile=/liquibase/changelog/v1.json"]
          env:
          - name: LIQUIBASE_URL
            value: "jdbc:postgresql://${database_host}:${database_port}/${database_name}"
          # TODO: move credentials out to secrets as files
          - name: LIQUIBASE_USERNAME
            value: "postgres"
          - name: LIQUIBASE_PASSWORD
            value: "postgres"
          volumeMounts:
          - name: liquibase-changelog-volume
            mountPath: /liquibase/changelog
      containers:
        - image: ${image_repo}:${image_tag}
          imagePullPolicy: ${image_pull_policy}
          resources:
            limits:
              memory: ${limits_memory}
            requests:
              memory: ${requests_memory}
